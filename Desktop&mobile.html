<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Omar IPTV Pro</title>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#121212;
  color:white;
}

header{
  display:flex;
  align-items:center;
  padding:15px;
  background:#1f1f1f;
}

#menuBtn{
  font-size:24px;
  cursor:pointer;
  margin-right:15px;
}

h1{margin:0;color:#00ccff;}

#layout{display:flex;}

#sidebar{
  width:260px;
  background:#1a1a1a;
  height:100vh;
  position:fixed;
  left:-260px;
  transition:0.3s;
  padding:15px;
  overflow-y:auto;
}

#sidebar.active{left:0;}

.sidebar-section{margin-bottom:25px;}

.sidebar-section h3{
  margin-bottom:10px;
  color:#00ccff;
}

.sidebar-section ul{
  list-style:none;
  padding:0;
}

.sidebar-section li{
  padding:6px 0;
  cursor:pointer;
  border-bottom:1px solid #333;
}

#main{
  flex:1;
  padding:20px;
  margin-left:0;
  transition:0.3s;
}

#main.shift{margin-left:260px;}

#playerContainer{
  position:relative;
  max-width:900px;
  margin:auto;
}

video{
  width:100%;
  background:black;
}

#buffering{
  position:absolute;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.7);
  padding:6px 14px;
  border-radius:6px;
  display:none;
}

#controlsBar{
  margin:15px auto;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
}

select,button{
  padding:8px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}

button{background:#ff9800;}
select{background:#00ccff;color:black;}

#search{
  width:100%;
  max-width:900px;
  padding:10px;
  margin:15px auto;
  display:block;
  border-radius:6px;
  border:none;
  font-size:16px;
  background:#1f1f1f;
  color:white;
}

#channelList{
  list-style:none;
  padding:0;
  max-width:900px;
  margin:auto;
}

#channelList li{
  padding:10px;
  border-bottom:1px solid #333;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
}

#channelList li:hover{background:#222;}

.favBtn{
  color:gold;
  cursor:pointer;
}
</style>
</head>
<body>

<header>
<div id="menuBtn">☰</div>
<h1>Omar IPTV Pro</h1>
</header>

<div id="layout">

<div id="sidebar">

  <div class="sidebar-section">
    <h3>Categories</h3>
    <ul id="categories"></ul>
  </div>

  <div class="sidebar-section">
    <h3>Last Watched</h3>
    <ul id="lastWatched"></ul>
  </div>

  <div class="sidebar-section">
    <h3>Favorites</h3>
    <ul id="favorites"></ul>
  </div>

</div>

<div id="main">

<div id="playerContainer">
<video id="player" controls></video>
<div id="buffering">Buffering...</div>
</div>

<div id="controlsBar">
<select id="qualitySelect">
<option value="-1">Auto</option>
</select>
</div>

<input type="text" id="search" placeholder="Search channels...">
<ul id="channelList"></ul>

</div>
</div>

<script>
const playlistURL="playlist.m3u";
const player=document.getElementById("player");
const channelList=document.getElementById("channelList");
const searchInput=document.getElementById("search");
const sidebar=document.getElementById("sidebar");
const main=document.getElementById("main");
const lastWatchedList=document.getElementById("lastWatched");
const favoritesList=document.getElementById("favorites");
const categoriesList=document.getElementById("categories");
const buffering=document.getElementById("buffering");
const qualitySelect=document.getElementById("qualitySelect");

let currentHls;
let channels=[];
let categories={};

let favorites=JSON.parse(localStorage.getItem("favorites")||"[]");
let lastWatched=JSON.parse(localStorage.getItem("lastWatched")||"[]");

document.getElementById("menuBtn").onclick=()=>{
  sidebar.classList.toggle("active");
  main.classList.toggle("shift");
};

/* HLS + QUALITY */
function playStream(url,name){
  if(currentHls){currentHls.destroy();}

  if(url.endsWith(".m3u8") && Hls.isSupported()){
    currentHls=new Hls();
    currentHls.loadSource(url);
    currentHls.attachMedia(player);

    currentHls.on(Hls.Events.MANIFEST_PARSED,function(){
      buildQualitySelector(currentHls);
    });
  }else{
    player.src=url;
  }

  player.play();
  saveLastWatched(name,url);
}

function buildQualitySelector(hls){
  qualitySelect.innerHTML='<option value="-1">Auto</option>';

  hls.levels.forEach((level,index)=>{
    if(level.height>=144){
      const option=document.createElement("option");
      option.value=index;
      option.textContent=level.height+"p";
      qualitySelect.appendChild(option);
    }
  });
}

qualitySelect.addEventListener("change",function(){
  if(!currentHls)return;
  currentHls.currentLevel=parseInt(this.value);
});

/* BUFFERING */
player.addEventListener("waiting",()=>buffering.style.display="block");
player.addEventListener("playing",()=>buffering.style.display="none");

/* LAST WATCHED */
function saveLastWatched(name,url){
  lastWatched=lastWatched.filter(c=>c.url!==url);
  lastWatched.unshift({name,url});
  if(lastWatched.length>10)lastWatched.pop();
  localStorage.setItem("lastWatched",JSON.stringify(lastWatched));
  renderLastWatched();
}

function renderLastWatched(){
  lastWatchedList.innerHTML="";
  lastWatched.forEach(c=>{
    const li=document.createElement("li");
    li.textContent=c.name;
    li.onclick=()=>playStream(c.url,c.name);
    lastWatchedList.appendChild(li);
  });
}

/* FAVORITES */
function toggleFavorite(name,url){
  const exists=favorites.find(c=>c.url===url);
  if(exists){
    favorites=favorites.filter(c=>c.url!==url);
  }else{
    favorites.push({name,url});
  }
  localStorage.setItem("favorites",JSON.stringify(favorites));
  renderFavorites();
}

function renderFavorites(){
  favoritesList.innerHTML="";
  favorites.forEach(c=>{
    const li=document.createElement("li");
    li.textContent=c.name;
    li.onclick=()=>playStream(c.url,c.name);
    favoritesList.appendChild(li);
  });
}

/* LOAD PLAYLIST WITH CATEGORIES */
fetch(playlistURL)
.then(r=>r.text())
.then(text=>{
  const lines=text.split(/\r?\n/);
  let current={};

  lines.forEach(line=>{
    if(line.startsWith("#EXTINF")){
      const nameMatch=line.match(/,(.*)$/);
      current.name=nameMatch?nameMatch[1].trim():"Unnamed";

      const groupMatch=line.match(/group-title="([^"]+)"/);
      current.category=groupMatch?groupMatch[1]:"Uncategorized";
    }
    else if(line && !line.startsWith("#")){
      current.url=line.trim();

      channels.push(current);

      if(!categories[current.category]){
        categories[current.category]=[];
      }
      categories[current.category].push(current);

      current={};
    }
  });

  renderChannels(channels);
  renderCategories();
});

function renderChannels(list){
  channelList.innerHTML="";
  list.forEach(ch=>{
    const li=document.createElement("li");
    li.innerHTML=`${ch.name} <span class="favBtn">★</span>`;
    li.onclick=()=>playStream(ch.url,ch.name);
    li.querySelector(".favBtn").onclick=(e)=>{
      e.stopPropagation();
      toggleFavorite(ch.name,ch.url);
    };
    channelList.appendChild(li);
  });
}

function renderCategories(){
  categoriesList.innerHTML="";

  const allLi=document.createElement("li");
  allLi.textContent="All Channels";
  allLi.onclick=()=>renderChannels(channels);
  categoriesList.appendChild(allLi);

  Object.keys(categories).forEach(cat=>{
    const li=document.createElement("li");
    li.textContent=cat;
    li.onclick=()=>renderChannels(categories[cat]);
    categoriesList.appendChild(li);
  });
}

/* SEARCH */
searchInput.addEventListener("input",()=>{
  const q=searchInput.value.toLowerCase();
  const filtered=channels.filter(c=>c.name.toLowerCase().includes(q));
  renderChannels(filtered);
});

renderFavorites();
renderLastWatched();
</script>

</body>
</html>
